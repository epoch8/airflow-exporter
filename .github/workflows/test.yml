name: Test airflow-exporter

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - '*'

jobs:

  test:
 
    runs-on: ubuntu-latest
    services:
      postgres:
        image: "postgres:9.6"
        env:
          POSTGRES_USER: airflow
          POSTGRES_PASSWORD: airflow
          POSTGRES_DB: airflow
        ports:
        - "5432"

    container:
      image: python:3.8
      env:
        AIRFLOW_HOME: tests/

    steps:
    - uses: actions/checkout@v1

    - name: Install Airflow
      run: pip install "apache-airflow >= 2.2.0"

    - name: Install airflow-exporter
      run: pip install .

    - name: Prepare DAG statuses
      run: |
        airflow scheduler scheduler -n 1

        airflow scheduler dags unpause dummy_dag
        airflow scheduler dags unpause slow_dag
        airflow scheduler dags trigger dummy_dag

    - name: Wait for Airflow and query metrics
      run: |
        sh tests/test_metrics_up.sh
